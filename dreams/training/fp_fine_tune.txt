# First, set up environment variables
$(python -c "from dreams.definitions import export; export()")

# Download the CANOPUS dataset first:
# mkdir -p data/paired_spectra/
# cd data/paired_spectra/
# wget -O canopus_train_export.tar "https://zenodo.org/record/8316682/files/canopus_train_export_v2.tar"
# tar -xvf canopus_train_export.tar
# mv canopus_train_export canopus_train
# rm -f canopus_train_export.tar
# cd ../../

# Then run the fine-tuning (you may need to convert the MIST format to DreaMS HDF5 format first)
# Fine-tuning DreaMS for Morgan 4096 molecular fingerprints
# Using CANOPUS benchmark dataset (8,000 spectra from 7,000 unique molecules)

# 1. Download CANOPUS benchmark dataset from MIST repository
# Dataset available at: https://zenodo.org/records/8015962
wget -O canopus_benchmark.zip "https://zenodo.org/records/8015962/files/canopus_train.zip?download=1"
unzip canopus_benchmark.zip

# 2. Convert MIST format to DreaMS HDF5 format
python3 ../../convert_canopus_to_dreams.py canopus_train canopus_train_dreams.hdf5

# 3. Activate conda environment with DreaMS dependencies
conda activate dreams_env

# First, set up environment variables
$(python -c "from dreams.definitions import export; export()")

# Step 1: Convert CANOPUS dataset to DreaMS HDF5 format (with fold column)
echo "Converting CANOPUS dataset to DreaMS format..."
python3 ./scripts/simple_canopus_converter.py \
    ./data/paired_spectra/canopus_train \
    ./data/paired_spectra/canopus_train_dreams.hdf5

# Step 2: Fix any spectrum issues that could cause division by zero
echo "Checking and fixing spectrum data..."
python3 ./scripts/fix_hdf5_spectra.py \
    ./data/paired_spectra/canopus_train_dreams.hdf5 \
    ./data/paired_spectra/canopus_train_dreams_fixed.hdf5

# Step 3: Verify conversion worked
python3 ./scripts/test_dreams_hdf5.py ./data/paired_spectra/canopus_train_dreams_fixed.hdf5

# Step 4: Fine-tuning command for Morgan 4096 fingerprints
echo "Starting fine-tuning..."
python3 dreams/training/train.py \
 --no_wandb \
 --project_name MorganFingerprints \
 --job_key "morgan_4096_fine_tune" \
 --run_name "morgan_4096_fine_tune" \
 --train_objective fp_morgan_4096 \
 --train_regime fine-tuning \
 --dataset_pth "./data/paired_spectra/canopus_train_dreams.hdf5" \
 --dformat A \
 --model DreaMS \
 --num_workers_data 8 \
 --lr 1e-4 \
 --batch_size 2 \
 --prec_intens 1.1 \
 --num_devices 1 \
 --max_epochs 100 \
 --log_every_n_steps 10 \
 --head_depth 1 \
 --seed 3407 \
 --train_precision 32 \
 --pre_trained_pth "${PRETRAINED}/ssl_model.ckpt" \
 --val_check_interval 0.1 \
 --max_peaks_n 100 \
 --save_top_k 3 \
 --val_frac 0.2 \
 --weight_decay 1e-5

